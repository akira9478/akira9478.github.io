
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sculpt | 智能健身教練</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1', 400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        blue: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #1e293b; margin: 0; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Select Reset */
        select { -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }

        /* Hide Number Spinners */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- CONFIGURATION ---
        const WRKOUT_RAW_BASE = "https://raw.githubusercontent.com/wrkout/exercises.json/master/exercises";
        
        const FILES = [
            'ex-json/abdominals_beginner.json', 'ex-json/abdominals_intermediate.json', 'ex-json/abdominals_expert.json',
            'ex-json/quadriceps_beginner.json', 'ex-json/quadriceps_intermediate.json', 'ex-json/quadriceps_expert.json',
            'ex-json/chest_beginner.json', 'ex-json/chest_intermediate.json', 'ex-json/chest_expert.json',
            'ex-json/shoulders_beginner.json', 'ex-json/shoulders_intermediate.json', 'ex-json/shoulders_expert.json',
            'ex-json/hamstrings_beginner.json', 'ex-json/hamstrings_intermediate.json', 'ex-json/hamstrings_expert.json',
            'ex-json/triceps_beginner.json', 'ex-json/triceps_intermediate.json', 'ex-json/triceps_expert.json',
            'ex-json/biceps_beginner.json', 'ex-json/biceps_intermediate.json', 'ex-json/biceps_expert.json',
            'ex-json/lats.json', 'ex-json/middle_back.json', 'ex-json/lower_back.json', 'ex-json/traps.json',
            'ex-json/forearms.json', 'ex-json/glutes.json', 'ex-json/calves.json',
            'ex-json/adductors.json', 'ex-json/abductors.json', 'ex-json/neck.json'
        ];

        const RepoToAppMap = {
            "Abdominals": "核心", "Quadriceps": "腿前側", "Hamstrings": "腿後側", "Calves": "小腿", "Glutes": "臀部",
            "Chest": "胸部", "Lats": "背部(闊背)", "Middle Back": "背部(中)", "Lower Back": "背部(下)", "Traps": "斜方肌",
            "Shoulders": "肩部", "Biceps": "二頭肌", "Triceps": "三頭肌", "Forearms": "前臂",
            "Adductors": "內收肌", "Abductors": "外展肌", "Neck": "頸部"
        };

        const SYSTEM_PRESETS = [
            { id: "FULL_BODY", name: "全身燃脂", description: "高強度的全身循環訓練。", icon: "Zap", color: "text-yellow-500", items: [ { id: "Air_Squat", sets: 3, reps: "15", weight: "0" }, { id: "Pushups", sets: 3, reps: "12", weight: "0" }, { id: "Lunges", sets: 3, reps: "20", weight: "0" }, { id: "Plank", sets: 3, reps: "60s", weight: "0" } ] },
            { id: "UPPER_POWER", name: "上肢力量", description: "胸背肩肌肥大訓練。", icon: "Dumbbell", color: "text-blue-500", items: [ { id: "Barbell_Bench_Press_-_Medium_Grip", sets: 4, reps: "8", weight: "40" }, { id: "Pullups", sets: 4, reps: "8", weight: "0" }, { id: "Barbell_Shoulder_Press", sets: 3, reps: "10", weight: "20" } ] },
            { id: "LOWER_STRENGTH", name: "下肢強化", description: "深蹲與硬舉，強壯地基。", icon: "Activity", color: "text-red-500", items: [ { id: "Barbell_Squat", sets: 5, reps: "5", weight: "60" }, { id: "Romanian_Deadlift", sets: 4, reps: "8", weight: "50" }, { id: "Walking_Lunges", sets: 3, reps: "12", weight: "10" } ] }
        ];

        // --- UTILS ---
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const generateHash = (items) => {
            try { return btoa(unescape(encodeURIComponent(JSON.stringify(items.map(i => ({ i: i.id, s: i.sets, r: i.reps, w: i.weight, n: i.note })))))); } catch(e) { return ""; }
        };

        const decodeHash = (hash, exercises) => {
            try {
                const json = JSON.parse(decodeURIComponent(escape(atob(hash))));
                return json.map(i => {
                    const ex = exercises.find(e => e.id === i.i) || { id: i.i, name: i.i, muscleGroup: "Unknown" };
                    return { uuid: crypto.randomUUID(), id: i.i, name: ex.name, muscleGroup: ex.muscleGroup, sets: i.s, reps: i.r, weight: i.w, note: i.n || "", completed: false, images: ex.images };
                });
            } catch(e) { return []; }
        };

        // --- COMPONENTS ---

        const Toast = ({ msg, type }) => (
            <div className={`fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-[100] font-bold text-sm animate-slide-up flex items-center gap-2 bg-slate-800 text-white`}>
                <Icon name={type==='error'?"alert-circle":"check"} size={16} className={type==='error'?"text-red-400":"text-emerald-400"}/>
                <span>{msg}</span>
            </div>
        );

        const ExerciseIllustration = ({ imageDir, name, className, autoPlay = false }) => {
            const [idx, setIdx] = useState(0);
            const [err, setErr] = useState(false);
            const url = `${WRKOUT_RAW_BASE}/${imageDir}/images/${idx}.jpg`;

            useEffect(() => {
                if (!autoPlay || err) return;
                const timer = setInterval(() => setIdx(p => p===0?1:0), 1500);
                return () => clearInterval(timer);
            }, [imageDir, err, autoPlay]);

            const placeholderUrl = `https://placehold.co/600x400/f1f5f9/cbd5e1?text=${encodeURIComponent(name)}`;

            return (
                <div className={`${className} relative overflow-hidden bg-white flex items-center justify-center`}>
                    <img src={err ? placeholderUrl : url} className="w-full h-full object-contain p-2" 
                        onError={() => { if(idx===1) setIdx(0); else setErr(true); }}
                        referrerPolicy="no-referrer"
                    />
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            useEffect(() => { document.body.style.overflow = isOpen ? 'hidden' : ''; }, [isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-0 md:p-4">
                    <div className="absolute inset-0 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={onClose} />
                    <div className="relative w-full md:max-w-md bg-white rounded-t-2xl md:rounded-2xl shadow-2xl overflow-hidden animate-slide-up max-h-[90vh] flex flex-col">
                        <div className="flex items-center justify-between p-4 border-b border-slate-100 shrink-0 bg-white">
                            <h3 className="font-bold text-lg text-slate-800">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-500 transition-colors"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="overflow-y-auto p-5 custom-scrollbar flex-1 pb-10">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const Hero = ({ onStart, onHistory }) => (
            <div className="min-h-screen flex flex-col items-center justify-center px-6 relative overflow-hidden animate-fade-in text-center bg-slate-50">
                <div className="z-10 max-w-2xl">
                    <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-blue-50 text-blue-600 mb-8 border border-blue-100">
                        <Icon name="activity" size={16} /> <span className="text-sm font-bold tracking-wide">Intelligent Fitness Architect</span>
                    </div>
                    <h1 className="text-5xl md:text-7xl font-bold mb-6 text-slate-900 tracking-tight leading-tight">雕塑你的<br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">意志與體態</span></h1>
                    <p className="text-lg text-slate-500 mb-10 leading-relaxed">這不僅是一份課表，而是你蛻變的藍圖。<br/>規劃、執行、紀錄，就在彈指之間。</p>
                    <div className="flex flex-col md:flex-row gap-4 justify-center">
                        <button onClick={onStart} className="px-8 py-4 bg-slate-900 hover:bg-slate-800 text-white rounded-full font-bold shadow-lg shadow-slate-300 transition-all hover:-translate-y-1 flex items-center justify-center gap-2">
                            開始規劃 <Icon name="arrow-right" size={20}/>
                        </button>
                        <button onClick={onHistory} className="px-8 py-4 bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 rounded-full font-bold transition-all flex items-center justify-center gap-2">
                            <Icon name="history" size={20}/> 歷史紀錄
                        </button>
                    </div>
                </div>
            </div>
        );

        const HistoryView = ({ history, onBack, onLoad }) => (
            <div className="min-h-screen bg-slate-50 animate-fade-in">
                <header className="sticky top-0 bg-white/90 backdrop-blur border-b border-slate-200 z-40 px-4 h-16 flex items-center gap-4">
                    <button onClick={onBack} className="p-2 hover:bg-slate-100 rounded-full text-slate-600"><Icon name="arrow-left" size={20}/></button>
                    <h2 className="font-bold text-lg text-slate-800">歷史紀錄</h2>
                </header>
                <div className="max-w-3xl mx-auto p-4 space-y-4">
                    {history.length === 0 && <div className="text-center py-20 text-slate-400">尚無訓練紀錄</div>}
                    {history.map((h, i) => (
                        <div key={h.id} className="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="flex justify-between items-start mb-4 border-b border-slate-100 pb-3">
                                <div>
                                    <h3 className="font-bold text-slate-800 text-lg">{new Date(h.date).toLocaleDateString()}</h3>
                                    <p className="text-xs text-slate-500">總項目: {h.items.length}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={()=>{navigator.clipboard.writeText(generateHash(h.items)); alert("代碼已複製")}} className="p-2 text-slate-400 hover:bg-slate-100 rounded-lg"><Icon name="share-2" size={18}/></button>
                                    <button onClick={()=>onLoad(h.items)} className="px-3 py-1.5 bg-slate-900 text-white text-xs font-bold rounded-lg">再次訓練</button>
                                </div>
                            </div>
                            <div className="space-y-2">
                                {h.items.map((item, idx) => (
                                    <div key={idx} className="flex justify-between text-sm text-slate-600">
                                        <span>{item.name}</span>
                                        <span className="font-mono text-slate-400">{item.weight}kg × {item.sets} × {item.reps}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        const Builder = ({ exercises, onAdd, onInfo, loading, plan, setPlan, presets, customPresets, onDeleteCustomPreset, onCopyCustomPreset }) => {
            const [search, setSearch] = useState("");
            const [muscle, setMuscle] = useState("ALL");
            const [limit, setLimit] = useState(12);
            const muscles = ["ALL", ...new Set(Object.values(RepoToAppMap))];
            
            const filtered = useMemo(() => exercises.filter(e => {
                const matchSearch = e.name.toLowerCase().includes(search.toLowerCase()) || e.id.toLowerCase().includes(search.toLowerCase());
                const matchMuscle = muscle === "ALL" || (RepoToAppMap[e.muscleGroup] || e.muscleGroup) === muscle;
                return matchSearch && matchMuscle;
            }), [exercises, search, muscle]);

            if(loading) return <div className="p-20 text-center text-slate-400 animate-pulse flex flex-col items-center gap-4"><Icon name="loader-2" className="animate-spin" size={32}/><span>載入資料庫中...</span></div>;

            return (
                <div className="pb-32 animate-fade-in">
                    {/* Sticky Header */}
                    <div className="sticky top-16 z-30 bg-white/95 backdrop-blur-md border-b border-slate-200 px-4 py-3 space-y-3 shadow-sm">
                        <div className="relative group">
                            <span className="absolute left-3 top-3 text-slate-400 group-focus-within:text-blue-500 transition-colors"><Icon name="search" size={18}/></span>
                            <input type="text" placeholder="搜尋動作 (如: 臥推, Squat)..." value={search} onChange={e=>setSearch(e.target.value)} 
                                className="w-full bg-slate-50 text-slate-800 pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder:text-slate-400" />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            {muscles.map(m => (
                                <button key={m} onClick={()=>{setMuscle(m);setLimit(12)}} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap border transition-all ${muscle===m?'bg-slate-900 border-slate-900 text-white shadow-md':'bg-white border-slate-200 text-slate-500 hover:border-slate-300 hover:text-slate-700'}`}>{m}</button>
                            ))}
                        </div>
                    </div>
                    
                    <div className="max-w-7xl mx-auto p-4 md:p-6">
                        {/* Presets */}
                        <div className="mb-8">
                            <h3 className="font-bold text-slate-800 text-lg mb-4 flex items-center gap-2"><Icon name="zap" size={20} className="text-yellow-500"/> 快速組合</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                {presets.map(p => (
                                    <button key={p.id} onClick={()=>setPlan(p.items.map(i=>{
                                        const ex=exercises.find(e=>e.id===i.id)||{name:i.id,muscleGroup:"Other"};
                                        return {uuid:crypto.randomUUID(), ...i, name:ex.name, muscleGroup:ex.muscleGroup, completed:false, note:"", images: ex.images}
                                    }))} className="p-5 bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md hover:border-blue-300 transition text-left group flex items-start gap-4">
                                        <div className={`p-3 rounded-lg bg-slate-50 ${p.color} group-hover:scale-110 transition-transform`}><Icon name={p.icon} size={24}/></div>
                                        <div>
                                            <h4 className="font-bold text-slate-800 group-hover:text-blue-600 transition-colors">{p.name}</h4>
                                            <p className="text-xs text-slate-500 mt-1">{p.description}</p>
                                        </div>
                                    </button>
                                ))}
                                {/* Custom Presets */}
                                {customPresets.map(p => (
                                    <div key={p.id} className="relative group">
                                         <button onClick={()=>setPlan(p.items.map(i=>{
                                            const ex=exercises.find(e=>e.id===i.id)||{name:i.id,muscleGroup:"Other"};
                                            return {uuid:crypto.randomUUID(), ...i, name:ex.name, muscleGroup:ex.muscleGroup, completed:false, note:i.note||"", images: ex.images}
                                        }))} className="w-full h-full p-5 bg-blue-50/50 rounded-xl border border-blue-100 shadow-sm hover:shadow-md hover:border-blue-300 transition text-left flex items-start gap-4">
                                            <div className="p-3 rounded-lg bg-blue-100 text-blue-600 group-hover:scale-110 transition-transform"><Icon name="user" size={24}/></div>
                                            <div>
                                                <h4 className="font-bold text-blue-900 group-hover:text-blue-600 transition-colors">{p.name}</h4>
                                                <p className="text-xs text-blue-600/60 mt-1">{p.items.length} 個動作</p>
                                            </div>
                                        </button>
                                        <div className="absolute top-2 right-2 flex gap-1">
                                            <button onClick={(e)=>{e.stopPropagation(); onCopyCustomPreset(p)}} className="p-2 text-slate-300 hover:text-blue-500 hover:bg-white rounded-full transition-all"><Icon name="share-2" size={16}/></button>
                                            <button onClick={(e)=>{e.stopPropagation(); onDeleteCustomPreset(p.id)}} className="p-2 text-slate-300 hover:text-red-500 hover:bg-white rounded-full transition-all"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Grid */}
                        <h3 className="font-bold text-slate-800 text-lg mb-4">動作庫 ({filtered.length})</h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {filtered.slice(0, limit).map(ex => (
                                <div key={ex.id} className="group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-lg transition-all overflow-hidden flex flex-col">
                                    <div className="aspect-[4/3] bg-slate-50 relative cursor-pointer overflow-hidden border-b border-slate-100" onClick={()=>onInfo(ex)}>
                                        <ExerciseIllustration imageDir={ex.images || ex.id} name={ex.name} className="w-full h-full" autoPlay={false} />
                                        <div className="absolute top-3 right-3 p-2 bg-white/90 backdrop-blur rounded-full text-slate-500 hover:text-blue-600 border border-slate-200 transition-colors shadow-sm"><Icon name="info" size={18}/></div>
                                        <div className="absolute top-3 left-3 px-2 py-1 bg-white/90 backdrop-blur rounded text-[10px] font-bold text-slate-600 border border-slate-200 uppercase tracking-wider">{ex.level}</div>
                                    </div>
                                    <div className="p-5 flex-1 flex flex-col">
                                        <div className="flex-1 mb-4">
                                            <span className="text-xs font-bold text-blue-600 mb-1 block">{RepoToAppMap[ex.muscleGroup]||ex.muscleGroup}</span>
                                            <h3 className="font-bold text-lg text-slate-900 leading-tight group-hover:text-blue-600 transition-colors">{ex.name}</h3>
                                        </div>
                                        <button onClick={()=>onAdd(ex)} className="w-full py-3 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-sm font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-md shadow-slate-200">
                                            <Icon name="plus" size={16}/> 加入訓練
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {limit < filtered.length && <div className="p-8 flex justify-center"><button onClick={()=>setLimit(l=>l+12)} className="px-8 py-3 bg-white hover:bg-slate-50 text-slate-600 rounded-full text-sm font-bold border border-slate-200 shadow-sm transition-all">載入更多</button></div>}
                    </div>
                </div>
            );
        };

        const MobileCart = ({ plan, onRemove, onEdit, onStart, onSavePreset, onShare }) => {
            const [expand, setExpand] = useState(false);
            if(plan.length===0) return null;
            
            return (
                <>
                    {/* Backdrop */}
                    {expand && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 transition-opacity" onClick={()=>setExpand(false)}/>}
                    
                    {/* Cart Sheet */}
                    <div className={`fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-[0_-10px_40px_rgba(0,0,0,0.1)] z-50 transition-all duration-500 cubic-bezier(0.32,0.72,0,1) ${expand?'h-[85vh] rounded-t-2xl':'h-[88px]'}`}>
                        <div className="h-[88px] px-6 flex items-center justify-between cursor-pointer bg-white z-10 relative rounded-t-2xl" onClick={()=>setExpand(!expand)}>
                            <div className="flex items-center gap-4">
                                <div className="relative">
                                    <div className="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-600 border border-slate-200"><Icon name="dumbbell" size={24}/></div>
                                    <span className="absolute -top-2 -right-2 w-6 h-6 bg-blue-600 text-white text-xs flex items-center justify-center rounded-full font-bold shadow-md border-2 border-white">{plan.length}</span>
                                </div>
                                <div>
                                    <h3 className="font-bold text-slate-900 text-base">訓練清單</h3>
                                    <p className="text-xs text-slate-500 mt-0.5 flex items-center gap-1">{expand?'點擊收合':'點擊查看詳情'} <Icon name={expand?"chevron-down":"chevron-up"} size={14}/></p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={(e)=>{e.stopPropagation();onStart()}} className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-200 active:scale-95 transition-all"><Icon name="play" size={18} fill="currentColor"/> 開始</button>
                            </div>
                        </div>
                        
                        {/* Expandable Content */}
                        <div className={`absolute top-[88px] left-0 right-0 bottom-0 flex flex-col transition-opacity duration-300 ${expand?'opacity-100':'opacity-0 pointer-events-none'}`}>
                             {/* Actions Bar */}
                             <div className="px-4 py-2 border-b border-slate-100 flex gap-2 overflow-x-auto no-scrollbar shrink-0 bg-white">
                                <button onClick={onShare} className="flex-1 py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-sm border border-slate-200 flex items-center justify-center gap-2 hover:bg-slate-100"><Icon name="share-2" size={16}/> 分享/複製</button>
                                <button onClick={onSavePreset} className="flex-1 py-3 bg-slate-50 text-slate-600 rounded-xl font-bold text-sm border border-slate-200 flex items-center justify-center gap-2 hover:bg-slate-100"><Icon name="save" size={16}/> 儲存為組合</button>
                             </div>

                             <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar bg-slate-50">
                                {plan.map((item, idx) => (
                                    <div key={item.uuid} className="flex justify-between items-center p-4 bg-white rounded-xl border border-slate-200 shadow-sm animate-slide-up" style={{animationDelay: `${idx*0.05}s`}}>
                                        <div className="flex items-center gap-4 overflow-hidden">
                                            <span className="text-slate-300 font-bold text-lg w-6 text-center shrink-0">{idx+1}</span>
                                            <div className="overflow-hidden">
                                                <h4 className="font-bold text-slate-800 text-sm truncate">{item.name}</h4>
                                                <div className="flex items-center gap-2 mt-1">
                                                    <span className="px-2 py-0.5 bg-slate-100 text-slate-600 text-xs rounded font-medium whitespace-nowrap">{item.sets}組 × {item.reps}</span>
                                                    {parseInt(item.weight)>0 && <span className="px-2 py-0.5 bg-blue-50 text-blue-600 text-xs rounded font-medium whitespace-nowrap">{item.weight}kg</span>}
                                                    {item.note && <span className="px-2 py-0.5 bg-yellow-50 text-yellow-600 text-xs rounded font-medium truncate max-w-[120px] sm:max-w-[200px]" title={item.note}>{item.note}</span>}
                                                </div>
                                            </div>
                                        </div>
                                        <div className="flex gap-1 shrink-0 ml-2">
                                            <button onClick={()=>onEdit(item)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><Icon name="edit-3" size={18}/></button>
                                            <button onClick={()=>onRemove(item.uuid)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors"><Icon name="trash-2" size={18}/></button>
                                        </div>
                                    </div>
                                ))}
                                <div className="h-20"></div>
                             </div>
                        </div>
                    </div>
                </>
            );
        };

        const WorkoutView = ({ plan, onBack, onFinish, onToggle }) => {
            const progress = Math.round((plan.filter(i=>i.completed).length / plan.length) * 100);
            return (
                <div className="min-h-screen bg-slate-50 pb-24 animate-fade-in">
                    <div className="sticky top-0 bg-white/95 backdrop-blur border-b border-slate-200 p-4 flex justify-between items-center z-20 shadow-sm">
                        <button onClick={onBack} className="text-slate-500 hover:text-slate-900 text-sm flex gap-1 items-center font-bold px-2 py-1 rounded hover:bg-slate-100 transition-colors"><Icon name="arrow-left" size={18}/> 調整</button>
                        <h2 className="font-bold text-slate-800 tracking-wide flex items-center gap-2"><Icon name="activity" size={18} className="text-blue-600"/> 執行訓練</h2>
                        <div className="w-10"/>
                    </div>
                    
                    {/* Progress Bar */}
                    <div className="bg-white p-6 border-b border-slate-200 text-center">
                         <div className="text-4xl font-black text-slate-900 mb-2">{progress}%</div>
                         <div className="w-full bg-slate-100 h-3 rounded-full overflow-hidden"><div className="bg-blue-600 h-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(37,99,235,0.3)]" style={{width: `${progress}%`}}/></div>
                    </div>

                    <div className="p-4 space-y-3 max-w-3xl mx-auto mt-4">
                        {plan.map((item, idx) => (
                            <div key={item.uuid} onClick={()=>onToggle(item.uuid)} className={`group p-5 rounded-xl border flex items-center gap-4 cursor-pointer transition-all duration-300 ${item.completed?'bg-emerald-50 border-emerald-100 opacity-60':'bg-white border-slate-200 hover:border-blue-400 hover:shadow-md'}`}>
                                <div className={`w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all ${item.completed?'bg-emerald-500 border-emerald-500 text-white':'border-slate-300 text-transparent group-hover:border-blue-400'}`}>
                                    <Icon name="check" size={16} strokeWidth={3}/>
                                </div>
                                <div className="flex-1 overflow-hidden">
                                    <h4 className={`font-bold text-lg ${item.completed?'text-emerald-800 line-through':'text-slate-800'}`}>{item.name}</h4>
                                    <div className="text-sm text-slate-500 mt-1 flex flex-wrap gap-2 items-center">
                                        <span className="bg-slate-100 px-2 py-0.5 rounded border border-slate-200 whitespace-nowrap">{item.sets}組</span>
                                        <span className="bg-slate-100 px-2 py-0.5 rounded border border-slate-200 whitespace-nowrap">{item.reps}次</span>
                                        {parseInt(item.weight)>0 && <span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100 font-bold whitespace-nowrap">{item.weight}kg</span>}
                                        {item.note && <span className="bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded border border-yellow-100 truncate max-w-[200px]" title={item.note}>{item.note}</span>}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-200 backdrop-blur z-30">
                        <button onClick={onFinish} disabled={progress<100} className={`w-full py-4 rounded-xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg text-lg ${progress===100?'bg-emerald-600 hover:bg-emerald-500 text-white shadow-emerald-200 scale-105':'bg-slate-100 text-slate-400 cursor-not-allowed'}`}>
                            <Icon name="trophy" size={24}/> 完成訓練
                        </button>
                    </div>
                </div>
            );
        };

        const CounterInput = ({ label, value, onChange, min = 0, step = 1, unit = "" }) => (
            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col items-center">
                <label className="text-xs text-slate-400 block mb-3 font-bold uppercase w-full text-left">{label}</label>
                <div className="flex items-center justify-between w-full gap-2">
                    <button onClick={() => onChange(Math.max(min, Number(value) - step))} className="w-12 h-12 shrink-0 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center font-bold text-xl transition active:scale-90">-</button>
                    <div className="flex-1 flex items-baseline justify-center gap-1">
                        <input 
                            type="number" 
                            value={value} 
                            onChange={(e) => onChange(Number(e.target.value))}
                            className="w-20 text-center font-bold text-2xl bg-transparent focus:outline-none focus:border-b-2 focus:border-blue-500 transition-colors p-0 m-0"
                        />
                        <span className="text-xs text-slate-400 font-bold">{unit}</span>
                    </div>
                    <button onClick={() => onChange(Number(value) + step)} className="w-12 h-12 shrink-0 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center font-bold text-xl transition active:scale-90">+</button>
                </div>
            </div>
        );

        // --- APP ---
        const App = () => {
            const [view, setView] = useState("HERO");
            const [exercises, setExercises] = useState([]);
            const [plan, setPlan] = useState(() => JSON.parse(localStorage.getItem('sculpt_plan') || '[]'));
            const [loading, setLoading] = useState(true);
            const [history, setHistory] = useState(() => JSON.parse(localStorage.getItem('sculpt_history') || '[]'));
            const [customPresets, setCustomPresets] = useState(() => JSON.parse(localStorage.getItem('sculpt_custom_presets') || '[]'));
            const [toast, setToast] = useState(null);
            
            // Modal States
            const [infoTarget, setInfoTarget] = useState(null);
            const [configTarget, setConfigTarget] = useState(null);
            const [editTarget, setEditTarget] = useState(null);
            const [showImport, setShowImport] = useState(false);
            const [showSavePreset, setShowSavePreset] = useState(false);

            // Forms
            const [sets, setSets] = useState(3);
            const [reps, setReps] = useState(12);
            const [weight, setWeight] = useState(0);
            const [note, setNote] = useState("");
            const [importHash, setImportHash] = useState("");
            const [presetName, setPresetName] = useState("");

            useEffect(() => {
                const load = async () => {
                    const reqs = FILES.map(f => fetch(f).then(r=>r.ok?r.json():[]).catch(()=>[]));
                    const res = await Promise.all(reqs);
                    const all = res.flat();
                    const unique = Array.from(new Map(all.map(i=>[i.id, i])).values());
                    setExercises(unique);
                    setLoading(false);
                };
                load();
            }, []);

            useEffect(() => { localStorage.setItem('sculpt_plan', JSON.stringify(plan)); }, [plan]);
            useEffect(() => { localStorage.setItem('sculpt_history', JSON.stringify(history)); }, [history]);
            useEffect(() => { localStorage.setItem('sculpt_custom_presets', JSON.stringify(customPresets)); }, [customPresets]);

            const notify = (msg, type="info") => { setToast({msg, type}); setTimeout(()=>setToast(null), 3000); };

            const openConfig = (ex, item=null) => {
                if(item) {
                    // Find Original Exercise Data
                    const original = exercises.find(e => e.id === item.id);
                    if(original) setConfigTarget(original);
                    else setConfigTarget({id: item.id, name: item.name, muscleGroup: item.muscleGroup, images: item.images}); // Fallback

                    setEditTarget(item);
                    setSets(item.sets); 
                    setReps(parseInt(item.reps)||12); 
                    setWeight(parseInt(item.weight)||0); 
                    setNote(item.note||"");
                } else {
                    setConfigTarget(ex); 
                    setEditTarget(null);
                    setSets(3); 
                    setReps(12); 
                    setWeight(0); 
                    setNote("");
                }
            };

            const confirmAdd = () => {
                const item = { uuid: editTarget?.uuid || crypto.randomUUID(), id: configTarget.id, name: configTarget.name, muscleGroup: configTarget.muscleGroup, sets, reps, weight, note, completed: false, images: configTarget.images };
                if(editTarget) setPlan(p => p.map(i => i.uuid===item.uuid ? item : i));
                else setPlan(p => [...p, item]);
                notify(editTarget?"已更新":"已加入清單", "success");
                setConfigTarget(null);
            };

            const savePreset = () => {
                if(!presetName.trim()) return notify("請輸入組合名稱", "error");
                const newPreset = { id: crypto.randomUUID(), name: presetName, items: plan };
                setCustomPresets(prev => [...prev, newPreset]);
                notify("組合已儲存", "success");
                setShowSavePreset(false);
                setPresetName("");
            };

            const finishWorkout = () => {
                const newRecord = { id: crypto.randomUUID(), date: new Date().toISOString(), items: plan };
                setHistory(h => [newRecord, ...h]);
                setPlan([]);
                setView("BUILDER"); // Changed: Stay on Builder view
                notify("訓練完成！紀錄已儲存", "success");
            };

            if(view === "HERO") return <Hero onStart={()=>setView("BUILDER")} onHistory={()=>setView("HISTORY")} />;
            if(view === "HISTORY") return <HistoryView history={history} onBack={()=>setView("BUILDER")} onLoad={(items)=>{setPlan(items.map(i=>({...i, uuid:crypto.randomUUID(), completed:false}))); setView("BUILDER"); notify("已載入歷史課表")}}/>;
            if(view === "WORKOUT") return <WorkoutView plan={plan} onBack={()=>setView("BUILDER")} onFinish={finishWorkout} onToggle={(uuid)=>setPlan(p=>p.map(i=>i.uuid===uuid?{...i, completed:!i.completed}:i))} />;

            return (
                <div className="min-h-screen bg-slate-50 selection:bg-blue-100 text-slate-900">
                    <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 sticky top-0 z-40 px-4 h-16 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2 cursor-pointer hover:opacity-80 transition-opacity" onClick={()=>setView("HERO")}>
                            <div className="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center font-bold text-white shadow-md">S</div>
                            <span className="font-bold text-lg tracking-tight text-slate-800">Sculpt</span>
                        </div>
                        <div className="flex gap-2 items-center">
                            <button onClick={()=>setShowImport(true)} className="px-4 py-1.5 bg-white hover:bg-slate-50 text-slate-700 hover:text-slate-900 text-xs font-bold rounded-full border border-slate-200 transition-all shadow-sm flex items-center gap-1"><Icon name="download" size={14}/> 匯入</button>
                            <button onClick={()=>setView("HISTORY")} className="p-2 hover:bg-slate-100 rounded-full text-slate-600 transition-colors" aria-label="歷史紀錄"><Icon name="history" size={20}/></button>
                        </div>
                    </header>

                    <Builder 
                        exercises={exercises} 
                        loading={loading} 
                        onAdd={(ex)=>openConfig(ex)} 
                        onInfo={setInfoTarget} 
                        plan={plan} 
                        setPlan={setPlan} 
                        presets={SYSTEM_PRESETS} 
                        customPresets={customPresets}
                        onDeleteCustomPreset={(id)=>setCustomPresets(p=>p.filter(x=>x.id!==id))}
                        onCopyCustomPreset={(p)=>{navigator.clipboard.writeText(generateHash(p.items)); notify("組合代碼已複製")}}
                    />
                    
                    <MobileCart 
                        plan={plan} 
                        onRemove={(id)=>setPlan(p=>p.filter(i=>i.uuid!==id))} 
                        onEdit={(item)=>openConfig(null, item)} 
                        onStart={()=>setView("WORKOUT")} 
                        onSavePreset={()=>setShowSavePreset(true)}
                        onShare={()=>{navigator.clipboard.writeText(generateHash(plan)); notify("代碼已複製")}}
                    />

                    {/* MODALS */}
                    <Modal isOpen={!!infoTarget} onClose={()=>setInfoTarget(null)} title={infoTarget?.name}>
                        <div className="space-y-6">
                            <ExerciseIllustration imageDir={infoTarget?.images || infoTarget?.id} name={infoTarget?.name} className="aspect-video rounded-xl border border-slate-100 bg-slate-50" autoPlay={true} />
                            
                            {/* Muscle Group Details */}
                            <div className="flex flex-wrap gap-2">
                                <span className="px-3 py-1 bg-blue-600 text-white text-xs font-bold rounded-full shadow-sm">{RepoToAppMap[infoTarget?.muscleGroup]||infoTarget?.muscleGroup}</span>
                                {infoTarget?.level && <span className="px-3 py-1 bg-slate-100 text-slate-600 text-xs font-bold rounded-full border border-slate-200">{infoTarget.level}</span>}
                            </div>

                             {infoTarget?.primaryMuscles && (
                                <div className="space-y-2">
                                    <div className="flex flex-wrap gap-2">
                                        <span className="text-xs font-bold text-slate-400 uppercase">主要肌群:</span>
                                        {infoTarget.primaryMuscles.map(m => <span key={m} className="text-xs text-slate-700 bg-slate-100 px-2 py-0.5 rounded">{m}</span>)}
                                    </div>
                                    {infoTarget.secondaryMuscles && infoTarget.secondaryMuscles.length > 0 && (
                                        <div className="flex flex-wrap gap-2">
                                            <span className="text-xs font-bold text-slate-400 uppercase">次要肌群:</span>
                                            {infoTarget.secondaryMuscles.map(m => <span key={m} className="text-xs text-slate-500 bg-slate-50 px-2 py-0.5 rounded">{m}</span>)}
                                        </div>
                                    )}
                                </div>
                            )}

                            <div className="prose prose-sm text-slate-600 border-t border-slate-100 pt-4">
                                <p>{infoTarget?.description || "暫無描述"}</p>
                            </div>
                            {infoTarget?.steps && (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                    <h4 className="font-bold text-slate-800 text-sm mb-3 flex items-center gap-2"><Icon name="list" size={16}/> 動作步驟</h4>
                                    <ol className="list-decimal list-inside text-sm space-y-2 text-slate-600 marker:text-slate-400 marker:font-bold">
                                        {infoTarget.steps.map((s,i)=><li key={i} className="pl-1">{s}</li>)}
                                    </ol>
                                </div>
                            )}
                        </div>
                    </Modal>

                    <Modal isOpen={!!configTarget} onClose={()=>{setConfigTarget(null);setEditTarget(null)}} title={editTarget?"編輯項目":"加入項目"}>
                        <div className="space-y-5">
                            {/* Big Image Section */}
                            <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden relative">
                                 <ExerciseIllustration imageDir={configTarget?.images || configTarget?.id} name={configTarget?.name} className="w-full h-48 bg-white object-contain" autoPlay={false}/>
                                 <div className="absolute bottom-0 left-0 right-0 p-3 bg-white/90 backdrop-blur border-t border-slate-100">
                                     <h4 className="font-bold text-slate-800 text-lg leading-tight text-center">{configTarget?.name}</h4>
                                 </div>
                            </div>
                            
                            {/* Mobile Friendly Inputs with Manual Typable Input */}
                            <div className="space-y-3">
                                <CounterInput label="組數" value={sets} onChange={setSets} min={1} unit="組" />
                                <CounterInput label="次數" value={reps} onChange={setReps} min={1} unit="次" />
                                <CounterInput label="重量" value={weight} onChange={setWeight} min={0} step={2.5} unit="kg" />
                            </div>

                            <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 ring-blue-500/20 transition-all">
                                <label className="text-xs text-slate-400 block mb-2 font-bold uppercase">備註</label>
                                <textarea placeholder="例如：座椅高度 4, 握距寬..." value={note} onChange={e=>setNote(e.target.value)} className="w-full bg-transparent text-slate-700 text-sm focus:outline-none resize-none h-16 placeholder:text-slate-300"/>
                            </div>
                            <button onClick={confirmAdd} className="w-full py-3.5 bg-slate-900 hover:bg-slate-800 text-white rounded-xl font-bold text-lg shadow-lg shadow-slate-300 transition-all hover:scale-[1.02] active:scale-[0.98]">確認</button>
                        </div>
                    </Modal>

                    <Modal isOpen={showSavePreset} onClose={()=>setShowSavePreset(false)} title="儲存組合">
                        <div className="space-y-4">
                            <p className="text-slate-500 text-sm">為目前的 {plan.length} 個動作取一個名字，方便日後快速載入。</p>
                            <input autoFocus type="text" value={presetName} onChange={e=>setPresetName(e.target.value)} placeholder="例如：週一練胸日" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 focus:outline-none text-slate-900 font-bold"/>
                            <button onClick={savePreset} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200">儲存</button>
                        </div>
                    </Modal>

                    <Modal isOpen={showImport} onClose={()=>setShowImport(false)} title="匯入課表">
                        <div className="space-y-4">
                            <textarea value={importHash} onChange={e=>setImportHash(e.target.value)} className="w-full h-32 bg-slate-50 p-4 rounded-xl text-slate-800 border border-slate-200 resize-none focus:border-blue-500 focus:outline-none font-mono text-xs shadow-inner" placeholder="在此貼上分享代碼..."/>
                            <button onClick={()=>{
                                const items = decodeHash(importHash, exercises);
                                if(items.length) { setPlan(items); notify("匯入成功", "success"); setShowImport(false); setImportHash(""); }
                                else notify("無效代碼", "error");
                            }} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold shadow-lg shadow-blue-200">載入</button>
                        </div>
                    </Modal>

                    {toast && <Toast msg={toast.msg} type={toast.type}/>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
